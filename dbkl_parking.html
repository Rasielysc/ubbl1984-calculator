<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UBBL Parking Requirement Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            text-align: justify;
            background-color: #111;
        }

        .topbar {
            background-color: #703D29;
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
        }
        .logo {
            height: 40px;
        }

        .overlay {
            min-height: 100vh;
            padding-top: 4.5rem;
        }

        .section {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            margin-bottom: 4rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            color: #111;
        }

        .main-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #fff;
        }

        .section-header {
            font-weight: 700;
            font-size: 1.25rem;
            color: #111;
            text-align: center;
            margin-bottom: 1rem;
        }

        p.section-text {
            font-size: 0.9rem;
            line-height: 1.8;
            font-weight: 400;
            color: #111;
            margin-bottom: 1rem;
        }

        .button-grey {
            background-color: #f3f4f6;
            color: #111;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border: 2px solid #888;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            font-size: 0.875rem;
            text-align: center;
        }
        .button-grey:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .btn-black {
            background-color: #000;
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn-black:hover {
            background-color: #222;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .result-box {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1.5rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }

        .formula {
            font-size: 0.75rem;
            color: #4a4a4a;
            margin-left: 0.5rem;
        }
        
        .message-box {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .main-title { font-size: 2rem; }
            .section-header { font-size: 1rem; }
            .section { padding: 1.5rem; margin-left: 1rem; margin-right: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <div class="topbar">
        <img src="assets/logo.png" alt="Company Logo" class="logo rounded-full">
    </div>

    <!-- Main Content -->
    <div class="overlay">
        <div class="max-w-5xl mx-auto space-y-12 py-12">

            <!-- Main Title -->
            <h1 class="main-title">DBKL Parking Requirement Calculator</h1>

            <!-- Calculator Section -->
            <div class="section">
                <div class="section-header">Calculate Parking Requirements</div>

                <!-- Message Box for errors -->
                <div id="messageBox" class="message-box hidden"></div>

                <form id="parkingForm" class="space-y-4">
                    <div>
                        <label for="buildingType" class="block text-sm font-medium text-gray-700">Building Type</label>
                        <select id="buildingType" name="buildingType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">Select a building type</option>
                            <option value="lowCostFlats">Low-cost flats / Public housing</option>
                            <option value="mediumCostFlatI">Medium Cost Flat I</option>
                            <option value="mediumCostFlatII">Medium Cost Flat II</option>
                            <option value="affordableHouse">Affordable House / PPA1M</option>
                            <option value="primaHousing">PRIMA Housing</option>
                            <option value="madaniHousing">MADANI Housing</option>
                            <option value="highCostFlatsI">High cost flats I</option>
                            <option value="highCostFlatsII">High cost flats II</option>
                            <option value="highCostFlatsIII">High cost flats III</option>
                            <option value="servicedApartment800">Serviced Apartment (800 sqft and above)</option>
                            <option value="servicedApartment450">Serviced Apartment (450-799 sqft)</option>
                            <option value="commercial">Perniagaan, Pusat Konvensyen, Pejabat, SOHO, Gedung Membeli belah</option>
                        </select>
                    </div>

                    <div id="unitsInputContainer" class="hidden">
                        <label for="numberOfUnits" class="block text-sm font-medium text-gray-700">Number of Units</label>
                        <input type="number" id="numberOfUnits" name="numberOfUnits" placeholder="e.g., 100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-black">
                    </div>

                    <div id="gfaInputContainer" class="hidden">
                        <label for="gfa" class="block text-sm font-medium text-gray-700">Gross Floor Area (GFA) in sqft</label>
                        <input type="number" id="gfa" name="gfa" placeholder="e.g., 50000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-black">
                    </div>

                    <div id="zoneInputContainer" class="hidden">
                        <label for="zone" class="block text-sm font-medium text-gray-700">Zone</label>
                        <select id="zone" name="zone" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="zone1">Zone 1</option>
                            <option value="zone2">Zone 2</option>
                            <option value="zone3">Zone 3</option>
                        </select>
                    </div>

                    <button type="button" onclick="calculateParking()" class="button-grey w-full mt-4">Calculate</button>
                </form>

                <div id="results" class="result-box hidden">
                    <div class="section-header">Required Parking Bays</div>
                    <div class="space-y-2">
                        <div class="result-item">
                            <span class="font-bold">Car Parking Bays (CPK):</span>
                            <span id="cpkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item" id="visitorRow">
                            <span class="font-bold">Visitor Parking Bays:</span>
                            <span id="visitorCpkResult" class="text-right">0</span>
                        </div>
                        <!-- New row for Total Car Parking Bays -->
                        <div class="result-item" id="totalCpkRow">
                            <span class="font-bold">Total Car Parking Bays:</span>
                            <span id="totalCpkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Motorcycle Parking Bays (MPK):</span>
                            <span id="mpkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Total Parking Bays (TLK):</span>
                            <span id="tlkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">E-hailing Pick-up Bays:</span>
                            <span id="ehailingMpkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">E-hailing Drop-off Bays:</span>
                            <span id="ehailingCpkResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">EV Charging Bays (EVCB):</span>
                            <span id="evcbResult" class="text-right">0</span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Disabled Bays (OKU):</span>
                            <span id="okuResult" class="text-right">0</span>
                        </div>
                    </div>
                    <button type="button" onclick="exportToExcel()" class="btn-black w-full mt-4">Export to Excel</button>
                </div>

                <!-- Back to Main Menu Button -->
                <div class="flex justify-center mt-8">
                    <a href="main.html" class="button-grey w-full md:w-1/3 flex items-center justify-center">
                        Back to Main Menu
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const parkingRules = {
            'lowCostFlats': { cpkPerUnit: 1, mpkCalc: (units) => Math.ceil(units * 0.5), ehailing: false, cpkVisitorPercent: 0 },
            'mediumCostFlatI': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.3), ehailing: false },
            'mediumCostFlatII': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.3), ehailing: false },
            'affordableHouse': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.3), ehailing: false },
            'primaHousing': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.1), ehailing: false },
            'madaniHousing': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.5), ehailing: false },
            'highCostFlatsI': { cpkPerUnit: 2, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.1), ehailing: false },
            'highCostFlatsII': { cpkPerUnit: 2.2, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.05), ehailing: false },
            'highCostFlatsIII': { cpkPerUnit: 2.5, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.ceil(units * 0.05), ehailing: false },
            'servicedApartment800': { gfaBased: true, cpkCalc: { zone1: 1000, zone2: 800, zone3: 500 }, cpkGfaDeduct: 0.35, cpkVisitorPercent: 0.1, mpkCalc: (gfa) => Math.ceil(gfa / 2000), ehailing: false },
            'servicedApartment450': { gfaBased: true, cpkCalc: { zone1: 1000, zone2: 800, zone3: 500 }, cpkGfaDeduct: 0.35, cpkVisitorPercent: 0, mpkCalc: (gfa) => Math.ceil(gfa / 2000), ehailing: false },
            'commercial': { gfaBased: true, cpkCalc: { zone1: 1000, zone2: 800, zone3: 500 }, cpkGfaDeduct: 0.35, mpkCalc: (gfa) => Math.ceil(gfa / 2000), ehailing: true }
        };

        // Global object to store calculation results
        let parkingResults = {};

        function showMessage(message) {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerText = message;
            messageBox.classList.remove('hidden');
        }

        function clearMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerText = '';
            messageBox.classList.add('hidden');
        }

        function updateForm() {
            const buildingType = document.getElementById('buildingType').value;
            const unitsContainer = document.getElementById('unitsInputContainer');
            const gfaContainer = document.getElementById('gfaInputContainer');
            const zoneContainer = document.getElementById('zoneInputContainer');
            const resultsDiv = document.getElementById('results');
            const visitorRow = document.getElementById('visitorRow');

            unitsContainer.classList.add('hidden');
            gfaContainer.classList.add('hidden');
            zoneContainer.classList.add('hidden');
            resultsDiv.classList.add('hidden');
            clearMessage();

            if (buildingType && parkingRules[buildingType]) {
                const rule = parkingRules[buildingType];
                if (rule.gfaBased) {
                    gfaContainer.classList.remove('hidden');
                    zoneContainer.classList.remove('hidden');
                } else {
                    unitsContainer.classList.remove('hidden');
                }
            }
        }

        document.getElementById('buildingType').addEventListener('change', updateForm);

        function calculateParking() {
            clearMessage();
            const buildingType = document.getElementById('buildingType').value;
            const units = parseInt(document.getElementById('numberOfUnits').value);
            const gfa = parseFloat(document.getElementById('gfa').value);
            const zone = document.getElementById('zone').value;
            const resultsDiv = document.getElementById('results');
            const visitorRow = document.getElementById('visitorRow');

            if (!buildingType) {
                showMessage('Please select a building type.');
                return;
            }

            const rule = parkingRules[buildingType];
            let cpk = 0;
            let residentialCpk = 0;
            let visitorCpk = 0;
            let mpk = 0;
            let ehailingCpk = 0;
            let ehailingMpk = 0;
            let totalBays = 0;

            let cpkFormula = "";
            let visitorCpkFormula = "";
            let mpkFormula = "";
            let ehailingCpkFormula = "";
            let ehailingMpkFormula = "";
            let evcbFormula = "";
            let okuFormula = "";
            
            let parameter = "";

            if (rule.gfaBased) {
                if (isNaN(gfa) || gfa <= 0) {
                    showMessage('Please enter a valid Gross Floor Area.');
                    return;
                }
                const cpkPerSqft = rule.cpkCalc[zone];
                const gfaDeducted = gfa * (1 - rule.cpkGfaDeduct);
                residentialCpk = Math.ceil(gfaDeducted / cpkPerSqft);
                cpkFormula = `(${gfa.toFixed(0)} - 35%) / ${cpkPerSqft}`;
                parameter = `GFA: ${gfa} sqft`;

                if (rule.cpkVisitorPercent) {
                    visitorCpk = Math.ceil(residentialCpk * rule.cpkVisitorPercent);
                    visitorRow.classList.remove('hidden');
                    visitorCpkFormula = `${residentialCpk} * ${Math.round(rule.cpkVisitorPercent * 100)}%`;
                } else {
                    visitorRow.classList.add('hidden');
                    visitorCpkFormula = `Not applicable`;
                }
                cpk = residentialCpk + visitorCpk;

                mpk = rule.mpkCalc(gfa);
                mpkFormula = `${gfa.toFixed(0)} / 2000`;

                if (rule.ehailing) {
                    if (gfa >= 100000 && gfa <= 199999) { ehailingMpk = 10; ehailingCpk = 2; }
                    else if (gfa >= 200000 && gfa <= 299999) { ehailingMpk = 12; ehailingCpk = 3; }
                    else if (gfa >= 300000 && gfa <= 399999) { ehailingMpk = 14; ehailingCpk = 4; }
                    else if (gfa >= 400000 && gfa <= 499999) { ehailingMpk = 16; ehailingCpk = 5; }
                    else if (gfa >= 500000) { ehailingMpk = 20; ehailingCpk = 5; }
                    ehailingCpkFormula = "Based on trade space area";
                    ehailingMpkFormula = "Based on trade space area";
                }
            } else {
                if (isNaN(units) || units <= 0) {
                    showMessage('Please enter a valid number of units.');
                    return;
                }
                residentialCpk = Math.ceil(units * rule.cpkPerUnit);
                cpkFormula = `${units} * ${rule.cpkPerUnit} bay/unit`;
                parameter = `Units: ${units}`;
                if (rule.cpkVisitorPercent) {
                    visitorCpk = Math.ceil(residentialCpk * rule.cpkVisitorPercent);
                    visitorRow.classList.remove('hidden');
                    visitorCpkFormula = `${residentialCpk} * ${Math.round(rule.cpkVisitorPercent * 100)}%`;
                } else {
                    visitorRow.classList.add('hidden');
                    visitorCpkFormula = `Not applicable`;
                }
                cpk = residentialCpk + visitorCpk;
                
                mpk = rule.mpkCalc(units);
                mpkFormula = `${units} * ${Math.round(rule.mpkCalc(1) * 100)}%`;
                ehailingCpkFormula = `Not applicable`;
                ehailingMpkFormula = `Not applicable`;
            }

            totalBays = cpk + mpk;

            // EV Charging Bays (EVCB) calculation based on TLK
            if (totalBays <= 50) { evcb = 1; evcbFormula = `1 EVCB for up to 50 TLK`; }
            else if (totalBays <= 100) { evcb = 2; evcbFormula = `2 EVCB for up to 100 TLK`; }
            else { evcb = 2 + Math.floor((totalBays - 100) / 100); evcbFormula = `2 + (TLK - 100) / 100`; }

            // Disabled (OKU) parking calculation based on CPK
            if (cpk <= 25) { oku = 1; okuFormula = `1 OKU for up to 25 CPK`; }
            else if (cpk <= 50) { oku = 2; okuFormula = `2 OKU for 26-50 CPK`; }
            else if (cpk <= 100) { oku = 4; okuFormula = `4 OKU for 51-100 CPK`; }
            else if (cpk <= 200) { oku = 6; okuFormula = `6 OKU for 101-200 CPK`; }
            else { oku = 6 + Math.floor((cpk - 200) / 100); okuFormula = `6 + (CPK - 200) / 100`; }

            // Store results in the global object
            parkingResults = {
                buildingType: document.getElementById('buildingType').options[document.getElementById('buildingType').selectedIndex].text,
                parameter: parameter,
                residentialCpk: residentialCpk,
                visitorCpk: visitorCpk,
                totalCpk: cpk,
                mpk: mpk,
                totalBays: totalBays,
                ehailingCpk: ehailingCpk,
                ehailingMpk: ehailingMpk,
                evcb: evcb,
                oku: oku,
                cpkFormula: cpkFormula,
                visitorCpkFormula: visitorCpkFormula,
                mpkFormula: mpkFormula,
                ehailingCpkFormula: ehailingCpkFormula,
                ehailingMpkFormula: ehailingMpkFormula,
                evcbFormula: evcbFormula,
                okuFormula: okuFormula
            };

            document.getElementById('cpkResult').innerHTML = `${residentialCpk} <span class="formula">(${cpkFormula})</span>`;
            document.getElementById('visitorCpkResult').innerHTML = `${visitorCpk} <span class="formula">(${visitorCpkFormula})</span>`;
            document.getElementById('totalCpkResult').innerHTML = `${cpk}`;
            document.getElementById('mpkResult').innerHTML = `${mpk} <span class="formula">(${mpkFormula})</span>`;
            document.getElementById('tlkResult').innerHTML = `${totalBays}`;
            document.getElementById('ehailingCpkResult').innerHTML = `${ehailingCpk} <span class="formula">(${ehailingCpkFormula})</span>`;
            document.getElementById('ehailingMpkResult').innerHTML = `${ehailingMpk} <span class="formula">(${ehailingMpkFormula})</span>`;
            document.getElementById('evcbResult').innerHTML = `${evcb} <span class="formula">(${evcbFormula})</span>`;
            document.getElementById('okuResult').innerHTML = `${oku} <span class="formula">(${okuFormula})</span>`;
            resultsDiv.classList.remove('hidden');
        }

        function exportToExcel() {
            if (Object.keys(parkingResults).length === 0) {
                showMessage("Please calculate the parking requirements first.");
                return;
            }

            const header = `"Category","Residential Car Bays","Visitor Bays","Total Car Bays","Motorcycle Bays","Total Parking Bays","E-hailing Pick-up Bays","E-hailing Drop-off Bays","EV Charging Bays","Disabled Bays"\n`;
            
            const buildingTypeRow = `"Building Type","${parkingResults.buildingType}",,`
                                  + `,,,,,,\n`;

            const parameterRow = `"Parameter","${parkingResults.parameter}",,`
                                  + `,,,,,,\n`;

            const formulaRow = `"Calculation Formula","${parkingResults.cpkFormula}",`
                             + `"${parkingResults.visitorCpkFormula}","","${parkingResults.mpkFormula}",`
                             + `"${parkingResults.totalBays}","${parkingResults.ehailingMpkFormula}",`
                             + `"${parkingResults.ehailingCpkFormula}","${parkingResults.evcbFormula}",`
                             + `"${parkingResults.okuFormula}"\n`;

            const requirementRow = `"Required Bays",`
                                 + `"${parkingResults.residentialCpk}","${parkingResults.visitorCpk}",`
                                 + `"${parkingResults.totalCpk}","${parkingResults.mpk}",`
                                 + `"${parkingResults.totalBays}","${parkingResults.ehailingMpk}",`
                                 + `"${parkingResults.ehailingCpk}","${parkingResults.evcb}",`
                                 + `"${parkingResults.oku}"\n`;

            const csvContent = header + buildingTypeRow + parameterRow + formulaRow + requirementRow;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "parking_requirements.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
