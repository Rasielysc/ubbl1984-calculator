<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UBBL Occupant Load & Capacity of Exit Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for the calculator */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('http://googleusercontent.com/image_generation_content/uploaded:ubbl_uniform_building_by_laws_1712756726_d2a55344_progressive-1153024906.jpg-428a9742-a7b1-4206-b501-ab9d80a5311c');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #374151; /* Default text color */
        }
        .overlay {
            background-color: rgba(244, 247, 246, 0.5);
            min-height: 100vh;
            padding: 1rem;
        }
        .section {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out; /* Fade-in animation for sections */
        }
        .button-red {
            background-color: #b91c1c; /* Dark red for primary actions */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem; /* Increased padding for better click area */
            border-radius: 0.5rem;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added transform and shadow transitions */
            letter-spacing: 0.05em; /* Slightly increased letter spacing */
        }
        .button-red:hover {
            background-color: #991b1b; /* Slightly darker red on hover */
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* Subtle shadow on hover */
        }
        .button-red:active {
            transform: translateY(0); /* Reset on click */
            box-shadow: none; /* No shadow on active */
        }
        .input-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: block;
            color: #374151; /* Darker gray for labels */
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.65rem; /* Slightly more padding */
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added transitions for input fields */
        }
        .form-input:focus, .form-select:focus {
            border-color: #b91c1c; /* Red border on focus */
            box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.3); /* Red shadow on focus */
            outline: none;
        }
        .results-pre {
            background: #f9fafb; /* Very light gray background for results */
            border: 1px solid #e5e7eb; /* Light border for results */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace; /* Monospace font for code-like output */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            color: #1f2937; /* Dark text for readability */
            overflow-x: auto; /* Allow horizontal scrolling for long lines */
        }
        .hidden-view {
            display: none; /* Class to hide sections */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Table specific styles */
        .ubbl-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            font-size: 0.9em;
        }
        .ubbl-table th, .ubbl-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        .ubbl-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        .ubbl-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
        .ubbl-table tbody tr:hover {
            background-color: #f0f4f7;
        }
    </style>
</head>
<body class="selection:bg-red-200 selection:text-red-800">
    <div class="overlay">
        <div class="max-w-5xl mx-auto space-y-8 py-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-6">
                <span class="text-red-700">UBBL Exit Width</span> Compliance Calculator
            </h1>

            <div id="mainMenuView" class="section text-center">
                <h2 class="text-2xl font-bold text-red-700 mb-4">
                    Select Your Calculation
                </h2>
                <p class="text-gray-600 mb-6 max-w-2xl mx-auto">
                    Quickly determine the required exit widths for stairs or doors based on building purpose group and floor area, ensuring compliance with fire safety regulations.
                </p>
                <div class="flex flex-col md:flex-row justify-center gap-6">
                    <button id="goToExitWidthInfo" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        What is Exit Width?
                    </button>
                    <button id="goToStairCalculator" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        Stair Width Calculator
                    </button>
                    <button id="goToDoorCalculator" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        Door Width Calculator
                    </button>
                </div>
            </div>

            <div id="calculatorView" class="section hidden-view">
                <h2 class="text-2xl font-bold text-red-700 mb-4 text-center">
                    <span id="calculatorTitle"></span> Width Calculation
                </h2>
                <p class="text-gray-600 mb-6 max-w-2xl mx-auto text-center">
                    Input the necessary details below to calculate the required width for your <span id="descriptionExitType"></span>. All calculations are based on UBBL 1984 seventh schedule.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="spaceName" class="input-label">
                            Space Name (Optional)
                        </label>
                        <input type="text" id="spaceName" class="form-input" placeholder="e.g., Level 1 Office" />
                    </div>
                    <div>
                        <label for="purposeGroup" class="input-label">
                            Purpose Group
                        </label>
                        <select id="purposeGroup" class="form-select">
                            <option value="">-- Select Purpose Group --</option>
                        </select>
                    </div>
                    <div>
                        <label for="floorArea" class="input-label">
                            Floor Area (m²)
                        </label>
                        <input type="number" id="floorArea" class="form-input" placeholder="e.g., 1000" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="numExits" class="input-label">
                            Number of <span id="exitTypeLabel"></span>
                        </label>
                        <input type="number" id="numExits" class="form-input" placeholder="e.g., 2" min="0" />
                    </div>
                </div>

                <div id="exitWidthsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"></div>

                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <button id="calculateCompliance" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        Calculate <span id="calculateButtonLabel"></span>
                    </button>
                    <button id="copyComplianceResults" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        Copy <span id="copyButtonLabel"></span> Results
                    </button>
                    <button id="downloadResults" class="button-red w-full md:w-1/3 flex items-center justify-center">
                        Download Results (XLSX)
                    </button>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">
                        <span id="resultsTypeLabel"></span> Calculation Results:
                    </h3>
                    <pre id="complianceResults" class="results-pre">Results will appear here...</pre>
                </div>

                <button id="backToMainMenuFromCalc" class="button-red mt-8 bg-gray-500 hover:bg-gray-600 w-full flex items-center justify-center">
                    Back to Main Menu
                </button>
            </div>

            <div id="exitWidthInfoView" class="section hidden-view">
                <h2 class="text-2xl font-bold text-red-700 mb-4 text-center">
                    What is Exit Width?
                </h2>
                <div class="text-gray-700 mb-6 space-y-4">
                    <p class="text-gray-600">
                        "Exit width" of "capacity of an exit" in the UBBL 7th schedule is simply how wide your exits (stairs, doors) must be to get everyone out safely.
                    </p>
                    <p class="font-bold">It's calculated like this:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Figure out how many people are there (Occupancy Load).</li>
                        <li>Determine how many "exit lanes" are needed for those people. (Stairs and doors have different "lane capacities.")</li>
                        <li>Multiply those "lanes" by a standard lane width (0.55m) to get the total required width.</li>
                    </ul>
                    <p class="font-bold mt-4">Example:</p>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p>If your office floor has an Occupancy Load of 100 people, and stairs can handle 60 people per "lane":</p>
                        <p class="mt-2">You need `100 / 60 = 1.67 exit lanes.`</p>
                        <p>So, the required stair width is `1.67 lanes * 0.55m/lane = 0.92 meters.`</p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4">UBBL 7th Schedule: Occupancy Load and Capacity of Exits</h3>
                    <div class="overflow-x-auto">
                        <table class="ubbl-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Purpose group</th>
                                    <th rowspan="2">Occupancy load (square metre per person)</th>
                                    <th colspan="5">Capacity of exits (No. of persons per unit-Exit width (1) and - (1A))</th>
                                </tr>
                                <tr>
                                    <th>Doors</th>
                                    <th>Horizontal exit</th>
                                    <th>Ramp main exit</th>
                                    <th>Ramp second exit</th>
                                    <th>Stairs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>I. Small residential</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                </tr>
                                <tr>
                                    <td>II. Institutional</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Classroom area</td>
                                    <td>2 net</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Workshop and vocational areas</td>
                                    <td>4.5 net</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                    <td>NR</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Day nurseries with sleeping facilities</td>
                                    <td>3.5 net</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>15</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Hospital Patient accommodation</td>
                                    <td>24 net</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>30</td>
                                    <td>15</td>
                                </tr>
                                <tr>
                                    <td>III. Other residential</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Flats</td>
                                    <td>20 gross</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>30</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">General public areas in hotels</td>
                                    <td>24 gross</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>30</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Hotels (bedroom in hotels at 2 person per room)</td>
                                    <td>24 gross</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>50</td>
                                    <td>30</td>
                                </tr>
                                <tr>
                                    <td>IV. Office</td>
                                    <td>10 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td>V. Shop</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Street floor and sale basement</td>
                                    <td>3 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Other floors</td>
                                    <td>6 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Storage and shipping</td>
                                    <td>10 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td>VI. Factory</td>
                                    <td>10 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td>VII. Place of assembly</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Areas of concentrated use without fixed seating</td>
                                    <td>1.5 net</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>75</td>
                                    <td>75</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Areas without fixed seating</td>
                                    <td>0.7 net</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>75</td>
                                    <td>75</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Standing space</td>
                                    <td>0.3 net</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>75</td>
                                    <td>75</td>
                                </tr>
                                <tr>
                                    <td>VIII. Storage and general</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Car parks</td>
                                    <td>20 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr>
                                    <td class="pl-4">Warehouse</td>
                                    <td>30 gross</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>100</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <button id="backToMainMenuFromInfo" class="button-red mt-8 bg-gray-500 hover:bg-gray-600 w-full flex items-center justify-center">
                    Back to Main Menu
                </button>
            </div>
            </div>
    </div>

    <script>
        // Data for different purpose groups, including net factor, stair capacity, and door capacity
        const purposeGroupData = [
            { name: "Institutional - Classroom area", netFactor: 2, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Institutional - Workshop and vocational areas", netFactor: 4.5, doorCapacity: null, horizontalExitCapacity: null, rampMainExitCapacity: null, rampSecondExitCapacity: null, stairCapacity: null }, // NR in image
            { name: "Institutional - Day nurseries with sleeping facilities", netFactor: 3.5, doorCapacity: 30, horizontalExitCapacity: 30, rampMainExitCapacity: 30, rampSecondExitCapacity: 30, stairCapacity: 15 },
            { name: "Institutional - Hospital (Patient accommodation)", netFactor: 24, doorCapacity: 30, horizontalExitCapacity: 30, rampMainExitCapacity: 30, rampSecondExitCapacity: 30, stairCapacity: 15 },
            { name: "Other residential - Flats", netFactor: 20, doorCapacity: 50, horizontalExitCapacity: 50, rampMainExitCapacity: 50, rampSecondExitCapacity: 50, stairCapacity: 30 },
            { name: "Other residential - General public areas in hotels", netFactor: 24, doorCapacity: 50, horizontalExitCapacity: 50, rampMainExitCapacity: 50, rampSecondExitCapacity: 50, stairCapacity: 30 },
            { name: "Other residential - Hotels (bedroom in hotels at 2 person per room)", netFactor: 24, doorCapacity: 50, horizontalExitCapacity: 50, rampMainExitCapacity: 50, rampSecondExitCapacity: 50, stairCapacity: 30 },
            { name: "Office", netFactor: 10, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Shop (Street floor and sale basement)", netFactor: 3, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Shop (Other floors)", netFactor: 6, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Shop (Storage and shipping)", netFactor: 10, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Factory", netFactor: 10, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 }, // Corrected stairCapacity to 60
            { name: "Place of assembly - Areas of concentrated use without fixed seating", netFactor: 1.5, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 75, stairCapacity: 75 },
            { name: "Place of assembly - Areas without fixed seating", netFactor: 0.7, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 75, stairCapacity: 75 },
            { name: "Place of assembly - Standing space", netFactor: 0.3, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 75, stairCapacity: 75 },
            { name: "Storage and general - Car parks", netFactor: 20, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 },
            { name: "Storage and general - Warehouse", netFactor: 30, doorCapacity: 100, horizontalExitCapacity: 100, rampMainExitCapacity: 100, rampSecondExitCapacity: 60, stairCapacity: 60 }
        ];

        const UNIT_WIDTH = 0.55; // Standard unit width for exit calculations

        let currentType = ""; // Stores "Stair" or "Door"
        let lastCalculationResults = null; // Stores the last calculated results for download

        // Get references to HTML elements
        const mainMenuView = document.getElementById("mainMenuView");
        const calculatorView = document.getElementById("calculatorView");
        const exitWidthInfoView = document.getElementById("exitWidthInfoView"); // New info view

        const goToStairCalculator = document.getElementById("goToStairCalculator");
        const goToDoorCalculator = document.getElementById("goToDoorCalculator");
        const goToExitWidthInfo = document.getElementById("goToExitWidthInfo"); // New info button

        const backToMainMenuFromCalc = document.getElementById("backToMainMenuFromCalc"); // Back button for calculator view
        const backToMainMenuFromInfo = document.getElementById("backToMainMenuFromInfo"); // Back button for info view

        const spaceNameInput = document.getElementById("spaceName"); // New space name input
        const purposeGroupSelect = document.getElementById("purposeGroup");
        const floorAreaInput = document.getElementById("floorArea");
        const numExitsInput = document.getElementById("numExits");
        const exitTypeLabel = document.getElementById("exitTypeLabel");
        const exitWidthsContainer = document.getElementById("exitWidthsContainer");
        const calculateCompliance = document.getElementById("calculateCompliance");
        const complianceResults = document.getElementById("complianceResults");
        const calculateButtonLabel = document.getElementById("calculateButtonLabel");
        const resultsTypeLabel = document.getElementById("resultsTypeLabel");
        const copyComplianceResults = document.getElementById("copyComplianceResults");
        const copyButtonLabel = document.getElementById("copyButtonLabel");
        const downloadResultsButton = document.getElementById("downloadResults");
        const calculatorTitle = document.getElementById("calculatorTitle");
        const descriptionExitType = document.getElementById("descriptionExitType");


        // Populates the Purpose Group dropdown with data
        function populatePurposeGroups() {
            purposeGroupSelect.innerHTML = '<option value="">-- Select Purpose Group --</option>';
            purposeGroupData.forEach(g => {
                const option = document.createElement("option");
                option.value = g.name;
                option.textContent = g.name;
                purposeGroupSelect.appendChild(option);
            });
        }

        // Hides all views
        function hideAllViews() {
            mainMenuView.classList.add("hidden-view");
            calculatorView.classList.add("hidden-view");
            exitWidthInfoView.classList.add("hidden-view");
        }

        // Shows the calculator view and sets the type (Stair or Door)
        function showCalculatorView(type) {
            hideAllViews(); // Hide all views first
            currentType = type;
            calculatorView.classList.remove("hidden-view"); // Show calculator
            exitTypeLabel.textContent = `${type}s`; // Update label for number of exits
            calculateButtonLabel.textContent = type; // Update calculate button label
            resultsTypeLabel.textContent = type; // Update results section label
            copyButtonLabel.textContent = type; // Update copy button label
            calculatorTitle.textContent = type; // Update title
            descriptionExitType.textContent = type.toLowerCase(); // Update description text

            // Reset inputs and results when switching calculator types
            spaceNameInput.value = ''; // Clear space name
            numExitsInput.value = '';
            floorAreaInput.value = '';
            purposeGroupSelect.value = '';
            exitWidthsContainer.innerHTML = '';
            complianceResults.textContent = 'Results will appear here...';
            lastCalculationResults = null; // Clear previous results
        }

        // Shows the main menu view
        function showMainMenuView() {
            hideAllViews(); // Hide all views first
            mainMenuView.classList.remove("hidden-view"); // Show main menu
        }

        // Shows the Exit Width Info view
        function showExitWidthInfoView() {
            hideAllViews(); // Hide all views first
            exitWidthInfoView.classList.remove("hidden-view"); // Show info view
        }

        // Dynamically generates input fields for exit widths based on the number of exits
        numExitsInput.addEventListener("input", () => {
            const count = parseInt(numExitsInput.value) || 0;
            exitWidthsContainer.innerHTML = ''; // Clear existing inputs
            for (let i = 1; i <= count; i++) {
                // Add a new input field for each exit width
                exitWidthsContainer.innerHTML += `
                    <div>
                        <label class="input-label">Width of ${currentType} ${i} (m):</label>
                        <input type="number" class="form-input" id="${currentType}Width${i}" value="0.9" min="0" step="0.01">
                    </div>
                `;
            }
        });

        // Handles the calculation logic
        calculateCompliance.addEventListener("click", () => {
            const spaceName = spaceNameInput.value.trim(); // Get space name
            const group = purposeGroupData.find(g => g.name === purposeGroupSelect.value);
            const area = parseFloat(floorAreaInput.value);
            const num = parseInt(numExitsInput.value);

            // Basic validation
            if (!group || isNaN(area) || area <= 0 || isNaN(num) || num < 0) {
                complianceResults.textContent = 'Please fill in all fields correctly: select a Purpose Group, enter a positive Floor Area, and a non-negative Number of Exits.';
                lastCalculationResults = null;
                return;
            }

            let widths = [];
            let totalProvidedWidth = 0;
            let largestWidth = 0;

            // Collect individual exit widths
            for (let i = 1; i <= num; i++) {
                const inputElement = document.getElementById(`${currentType}Width${i}`);
                if (!inputElement) {
                    complianceResults.textContent = `Error: Could not find width input for ${currentType} ${i}. Please re-enter number of exits.`;
                    lastCalculationResults = null;
                    return;
                }
                const val = parseFloat(inputElement.value);
                if (isNaN(val) || val < 0) {
                    complianceResults.textContent = `Error: Invalid width entered for ${currentType} ${i}. Please enter a positive number.`;
                    lastCalculationResults = null;
                    return;
                }
                widths.push(val);
                totalProvidedWidth += val;
                if (val > largestWidth) largestWidth = val;
            }

            // Calculate Occupancy Load
            const occupancyLoad = Math.ceil(area / group.netFactor);

            // Determine capacity per unit based on type (Stair or Door)
            const capacityPerUnit = currentType === 'Stair' ? group.stairCapacity : group.doorCapacity;

            // Handle NR (Not Required) capacities
            if (capacityPerUnit === null) {
                complianceResults.textContent = `Calculation not applicable for "${group.name}" for ${currentType}s (NR). Please select a different purpose group or a different exit type.`;
                lastCalculationResults = null;
                return;
            }

            // Calculate Required Exit Width
            const requiredUnitExits = occupancyLoad / capacityPerUnit;
            const requiredWidth = requiredUnitExits * UNIT_WIDTH;

            // Calculate Effective Width (excluding the largest door/stair)
            const effectiveWidthExclLargest = totalProvidedWidth - largestWidth;

            let resultText = `${currentType} Width Calculation:\n`;
            if (spaceName) {
                resultText += `Space Name: ${spaceName}\n`;
            }
            resultText += `Purpose Group: ${group.name}\n`;
            resultText += `Floor Area: ${area} m²\n`;
            resultText += `Number of ${currentType}s: ${num}\n\n`;

            resultText += `Occupancy Load = ${area} m² / ${group.netFactor} = ${occupancyLoad} PAX\n`;
            resultText += `Required Exit Units = ${occupancyLoad} PAX / ${capacityPerUnit} = ${requiredUnitExits.toFixed(2)} units\n`;
            resultText += `Required Width = ${requiredUnitExits.toFixed(2)} units * ${UNIT_WIDTH}m/unit = ${requiredWidth.toFixed(2)}m\n\n`;

            resultText += `Widths Provided:\n`;
            if (num > 0) {
                widths.forEach((width, index) => {
                    resultText += `${currentType} ${index + 1}: ${width.toFixed(2)}m\n`;
                });
            } else {
                resultText += `No ${currentType}s entered.\n`;
            }
            resultText += `Total Provided Width: ${totalProvidedWidth.toFixed(2)}m\n`;
            resultText += `Effective Width (excl. largest ${currentType}): ${effectiveWidthExclLargest.toFixed(2)}m\n\n`;


            // Compliance check
            const complianceStatus = totalProvidedWidth >= requiredWidth ? "Complies" : "Insufficient Width";
            const statusEmoji = totalProvidedWidth >= requiredWidth ? "✅" : "❌";
            resultText += `${statusEmoji} ${complianceStatus} (Required: ${requiredWidth.toFixed(2)}m)\n`;

            complianceResults.textContent = resultText;

            // Store results for XLSX download
            lastCalculationResults = {
                spaceName: spaceName,
                purposeGroup: group.name,
                floorArea: area,
                numExits: num,
                occupancyLoad: occupancyLoad,
                capacityPerUnit: capacityPerUnit,
                requiredUnitExits: requiredUnitExits,
                requiredWidth: requiredWidth,
                widths: widths,
                totalProvidedWidth: totalProvidedWidth,
                largestWidth: largestWidth, // Store largest width for effective calculation
                effectiveWidthExclLargest: effectiveWidthExclLargest,
                complianceStatus: complianceStatus,
                difference: totalProvidedWidth - requiredWidth
            };
        });

        // Copy results to clipboard
        copyComplianceResults.addEventListener("click", () => {
            if (complianceResults.textContent && complianceResults.textContent !== 'Results will appear here...') {
                // Using document.execCommand('copy') for broader compatibility in iframes
                const textarea = document.createElement('textarea');
                textarea.value = complianceResults.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    // Replace alert with a temporary message in the UI
                    const originalText = complianceResults.textContent;
                    complianceResults.textContent = "Results copied to clipboard!";
                    setTimeout(() => {
                        complianceResults.textContent = originalText;
                    }, 1500); // Message disappears after 1.5 seconds
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for failed copy
                    const originalText = complianceResults.textContent;
                    complianceResults.textContent = "Failed to copy. Please copy manually.";
                    setTimeout(() => {
                        complianceResults.textContent = originalText;
                    }, 2500);
                } finally {
                    document.body.removeChild(textarea);
                }
            } else {
                const originalText = complianceResults.textContent;
                complianceResults.textContent = "No results to copy yet. Please perform a calculation first.";
                setTimeout(() => {
                    complianceResults.textContent = originalText;
                }, 2500);
            }
        });

        // Download results as XLSX
        downloadResultsButton.addEventListener("click", () => {
            if (!lastCalculationResults) {
                const originalText = complianceResults.textContent;
                complianceResults.textContent = "No results to download yet. Please perform a calculation first.";
                setTimeout(() => {
                    complianceResults.textContent = originalText;
                }, 2500);
                return;
            }

            const results = lastCalculationResults;
            const data = [];

            // Add main calculation details
            data.push(["Calculation Type", `${currentType} Width Calculation`]);
            if (results.spaceName) {
                data.push(["Space Name", results.spaceName]);
            }
            data.push(["Purpose Group", results.purposeGroup]);
            data.push(["Floor Area (m²)", results.floorArea]);
            data.push([`Number of ${currentType}s`, results.numExits]);
            data.push([]); // Empty row for separation

            data.push(["Occupancy Load (PAX)", results.occupancyLoad]);
            data.push(["Required Exit Units", results.requiredUnitExits.toFixed(2)]);
            data.push([`Required Total ${currentType} Width (m)`, results.requiredWidth.toFixed(2)]);
            data.push([]); // Empty row for separation

            data.push(["Widths Provided:"]);
            results.widths.forEach((width, index) => {
                // Modified to put label and value in separate columns for XLSX
                data.push([`${currentType} ${index + 1}`, `${width.toFixed(2)}m`]);
            });
            data.push(["Total Provided Width (m)", results.totalProvidedWidth.toFixed(2)]);
            data.push([`Effective Width (excl. largest ${currentType}) (m)`, results.effectiveWidthExclLargest.toFixed(2)]);
            data.push([]); // Empty row for separation

            const statusText = `${results.complianceStatus} (Required: ${results.requiredWidth.toFixed(2)}m)`;
            data.push(["Compliance Status", statusText]);
            data.push(["Difference (m)", results.difference.toFixed(2)]);


            // Create a new workbook and a worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Add the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, "Compliance Results");

            // Write the workbook and trigger download
            XLSX.writeFile(wb, `${currentType.toLowerCase()}_compliance_results.xlsx`);
        });


        // Event Listeners for navigation buttons
        goToStairCalculator.addEventListener("click", () => showCalculatorView("Stair"));
        goToDoorCalculator.addEventListener("click", () => showCalculatorView("Door"));
        goToExitWidthInfo.addEventListener("click", showExitWidthInfoView); // New info button listener

        backToMainMenuFromCalc.addEventListener("click", showMainMenuView); // Back button for calculator
        backToMainMenuFromInfo.addEventListener("click", showMainMenuView); // Back button for info view

        // Initialize the calculator
        document.addEventListener("DOMContentLoaded", () => {
            populatePurposeGroups();
            showMainMenuView(); // Start with the main menu
        });
    </script>
</body>
</html>
